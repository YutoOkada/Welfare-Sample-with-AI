<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšœå®³ç¦ç¥‰ã®ç¾å ´ AIæ´»ç”¨äº‹ä¾‹ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 320px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
                max-height: 400px;
            }
        }
        .case-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .case-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .admin-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-neutral-50 text-neutral-800">

    <!-- Detail Modal -->
    <div id="detailModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-xl shadow-2xl p-6 md:p-8 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 id="detailModalTitle" class="text-2xl font-bold text-sky-700"></h2>
                <button id="closeDetailModal" class="text-neutral-500 hover:text-neutral-800 text-3xl font-light">&times;</button>
            </div>
            <div id="detailModalBody" class="space-y-4">
                <div>
                    <h3 class="text-lg font-semibold text-neutral-700 border-l-4 border-sky-500 pl-2 mb-2">ã€å…·ä½“çš„ãªæ´»ç”¨äº‹ä¾‹ã€‘</h3>
                    <p id="detailUseCase" class="text-neutral-700 leading-relaxed"></p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-neutral-700 border-l-4 border-amber-500 pl-2 mb-2">ã€å®Ÿç¸¾(æ¥­å‹™æ”¹å–„)ã€‘</h3>
                    <p id="detailResult" class="text-neutral-700 leading-relaxed"></p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-neutral-700 border-l-4 border-teal-500 pl-2 mb-2">ã€ãŸã ã®åŠ¹ç‡åŒ–ã§ã¯ãªã„éƒ¨åˆ†ï¼ˆç¦ç¥‰çš„é…æ…®ï¼‰ã€‘</h3>
                    <p id="detailWelfare" class="text-neutral-700 leading-relaxed"></p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-neutral-700 border-l-4 border-red-500 pl-2 mb-2">ã€å‹•ç”»é›†ã€‘</h3>
                    <div id="detailVideo" class="text-neutral-700 leading-relaxed"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div id="editModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-xl shadow-2xl p-6 md:p-8 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 id="editModalTitle" class="text-2xl font-bold text-sky-700">äº‹ä¾‹ã‚’ç·¨é›†</h2>
                <button id="closeEditModal" class="text-neutral-500 hover:text-neutral-800 text-3xl font-light">&times;</button>
            </div>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editRecordId" />
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-1">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                    <input type="text" id="editTitle" required class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-1">è·ç¨® *</label>
                        <input type="text" id="editRole" required class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-1">äº‹æ¥­æ‰€ç¨®åˆ¥ *</label>
                        <input type="text" id="editServiceType" required class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-1">æ¥­å‹™å†…å®¹ *</label>
                        <input type="text" id="editTask" required class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-1">å…·ä½“çš„ãªæ´»ç”¨äº‹ä¾‹ *</label>
                    <textarea id="editUseCase" required rows="3" class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-1">å®Ÿç¸¾ï¼ˆæ¥­å‹™æ”¹å–„ï¼‰ *</label>
                    <textarea id="editResult" required rows="3" class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-1">ç¦ç¥‰çš„é…æ…® *</label>
                    <textarea id="editWelfare" required rows="3" class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-neutral-700 mb-1">å‹•ç”»URLï¼ˆä»»æ„ï¼‰</label>
                    <input type="url" id="editVideoUrl" placeholder="https://..." class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="flex gap-3 justify-end">
                    <button type="button" id="cancelEdit" class="px-6 py-2 bg-neutral-500 text-white rounded-md hover:bg-neutral-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-6 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 transform scale-95">
            <h2 class="text-2xl font-bold text-sky-700 mb-4">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</h2>
            <p class="text-neutral-600 mb-4">äº‹ä¾‹ã®ç·¨é›†ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã«ã¯ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
            <form id="passwordForm">
                <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="w-full p-2 border border-neutral-300 rounded-md focus:ring-sky-500 focus:border-sky-500 mb-4">
                <div id="passwordError" class="text-red-600 text-sm mb-2 hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                <div class="flex gap-3 justify-end">
                    <button type="button" id="cancelPassword" class="px-6 py-2 bg-neutral-500 text-white rounded-md hover:bg-neutral-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-6 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">ç¢ºèª</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center my-8">
            <div class="flex justify-between items-center mb-4">
                <div></div>
                <h1 class="text-3xl md:text-4xl font-bold text-sky-800">éšœå®³ç¦ç¥‰ã®ç¾å ´ AIæ´»ç”¨äº‹ä¾‹ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
                <button id="adminToggle" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 transition-colors text-sm">
                    ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                </button>
            </div>
            <div id="adminBadge" class="hidden mb-4">
                <span class="admin-badge inline-block bg-red-500 text-white px-4 py-2 rounded-full text-sm font-semibold">
                    ğŸ”’ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹
                </span>
            </div>
            <p class="mt-4 text-lg text-neutral-600 max-w-3xl mx-auto">
                éšœå®³ç¦ç¥‰ã®ç¾å ´ã§ã€Œã™ãã«è©¦ã›ã‚‹ã€AIæ´»ç”¨äº‹ä¾‹50äº‹ä¾‹ä»¥ä¸Šã‚’ã€å¯¾è©±çš„ã«æ¤œç´¢ãƒ»é–²è¦§ã§ãã¾ã™ã€‚æ—¥ã€…ã®æ¥­å‹™ã‚’ã€Œç¦ç¥‰çš„é…æ…®ã‚’æŒã£ãŸAIæ´»ç”¨ã€ã§æ”¹å–„ã™ã‚‹ãƒ’ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚
            </p>
        </header>

        <main>
            <section id="filters" class="sticky top-0 z-40 bg-neutral-50/95 backdrop-blur-md py-4 mb-6 shadow-sm rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4">
                    <div class="md:col-span-4">
                        <label for="searchInput" class="block text-sm font-medium text-neutral-700 mb-1">ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                        <input type="text" id="searchInput" placeholder="ä¾‹ï¼š æ—¥å ±ã€SSTã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°..." class="w-full p-2 border border-neutral-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="roleFilter" class="block text-sm font-medium text-neutral-700 mb-1">è·ç¨®ã§çµã‚Šè¾¼ã¿</label>
                        <select id="roleFilter" class="w-full p-2 border border-neutral-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-white"></select>
                    </div>
                    <div>
                        <label for="serviceFilter" class="block text-sm font-medium text-neutral-700 mb-1">äº‹æ¥­æ‰€ç¨®åˆ¥ã§çµã‚Šè¾¼ã¿</label>
                        <select id="serviceFilter" class="w-full p-2 border border-neutral-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-white"></select>
                    </div>
                    <div>
                        <label for="taskFilter" class="block text-sm font-medium text-neutral-700 mb-1">æ¥­å‹™å†…å®¹ã§çµã‚Šè¾¼ã¿</label>
                        <select id="taskFilter" class="w-full p-2 border border-neutral-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-white"></select>
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="resetFilters" class="flex-1 p-2 bg-neutral-600 text-white rounded-md shadow-sm hover:bg-neutral-700 transition-colors">ãƒªã‚»ãƒƒãƒˆ</button>
                        <button id="addCaseBtn" class="hidden flex-1 p-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 transition-colors">+ æ–°è¦è¿½åŠ </button>
                    </div>
                </div>
            </section>

            <section id="dashboard" class="mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md flex flex-col justify-center">
                        <h2 class="text-xl font-semibold text-neutral-700 mb-2">è©²å½“äº‹ä¾‹</h2>
                        <p class="text-5xl font-bold text-sky-600"><span id="displayedCount">0</span> <span class="text-3xl text-neutral-500">/ <span id="totalCount">0</span></span></p>
                        <p class="text-neutral-500 mt-2">ä»¶</p>
                    </div>
                    <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold text-neutral-700 mb-4 text-center">äº‹ä¾‹ã®äº‹æ¥­æ‰€ç¨®åˆ¥ åˆ†å¸ƒ</h2>
                        <div class="chart-container">
                            <canvas id="serviceChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="gallery">
                <div id="caseGallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
                <p id="noResults" class="text-center text-xl text-neutral-500 py-16 hidden">è©²å½“ã™ã‚‹äº‹ä¾‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <p id="loading" class="text-center text-xl text-neutral-500 py-16">èª­ã¿è¾¼ã¿ä¸­...</p>
            </section>
        </main>
    </div>

    <script>
        // Global state
        let allCases = [];
        let isAdminMode = false;
        let serviceChart = null;
        const ADMIN_PASSWORD = '0325';

        // DOM Elements
        const elements = {
            caseGallery: document.getElementById('caseGallery'),
            searchInput: document.getElementById('searchInput'),
            roleFilter: document.getElementById('roleFilter'),
            serviceFilter: document.getElementById('serviceFilter'),
            taskFilter: document.getElementById('taskFilter'),
            resetFilters: document.getElementById('resetFilters'),
            displayedCount: document.getElementById('displayedCount'),
            totalCount: document.getElementById('totalCount'),
            noResults: document.getElementById('noResults'),
            loading: document.getElementById('loading'),
            
            detailModal: document.getElementById('detailModal'),
            closeDetailModal: document.getElementById('closeDetailModal'),
            detailModalTitle: document.getElementById('detailModalTitle'),
            detailUseCase: document.getElementById('detailUseCase'),
            detailResult: document.getElementById('detailResult'),
            detailWelfare: document.getElementById('detailWelfare'),
            detailVideo: document.getElementById('detailVideo'),
            
            editModal: document.getElementById('editModal'),
            closeEditModal: document.getElementById('closeEditModal'),
            editModalTitle: document.getElementById('editModalTitle'),
            editForm: document.getElementById('editForm'),
            editRecordId: document.getElementById('editRecordId'),
            editTitle: document.getElementById('editTitle'),
            editRole: document.getElementById('editRole'),
            editServiceType: document.getElementById('editServiceType'),
            editTask: document.getElementById('editTask'),
            editUseCase: document.getElementById('editUseCase'),
            editResult: document.getElementById('editResult'),
            editWelfare: document.getElementById('editWelfare'),
            editVideoUrl: document.getElementById('editVideoUrl'),
            cancelEdit: document.getElementById('cancelEdit'),
            
            passwordModal: document.getElementById('passwordModal'),
            passwordForm: document.getElementById('passwordForm'),
            passwordInput: document.getElementById('passwordInput'),
            passwordError: document.getElementById('passwordError'),
            cancelPassword: document.getElementById('cancelPassword'),
            
            adminToggle: document.getElementById('adminToggle'),
            adminBadge: document.getElementById('adminBadge'),
            addCaseBtn: document.getElementById('addCaseBtn')
        };

        // API Functions
        async function loadCases() {
            try {
                const response = await fetch('tables/cases?limit=1000');
                if (!response.ok) throw new Error('Failed to load cases');
                const data = await response.json();
                allCases = data.data || [];
                elements.loading.style.display = 'none';
                return allCases;
            } catch (error) {
                console.error('Error loading cases:', error);
                elements.loading.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                return [];
            }
        }

        async function createCase(caseData) {
            try {
                const response = await fetch('tables/cases', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(caseData)
                });
                if (!response.ok) throw new Error('Failed to create case');
                return await response.json();
            } catch (error) {
                console.error('Error creating case:', error);
                alert('äº‹ä¾‹ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                return null;
            }
        }

        async function updateCase(recordId, caseData) {
            try {
                const response = await fetch(`tables/cases/${recordId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(caseData)
                });
                if (!response.ok) throw new Error('Failed to update case');
                return await response.json();
            } catch (error) {
                console.error('Error updating case:', error);
                alert('äº‹ä¾‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                return null;
            }
        }

        async function deleteCase(recordId) {
            try {
                const response = await fetch(`tables/cases/${recordId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete case');
                return true;
            } catch (error) {
                console.error('Error deleting case:', error);
                alert('äº‹ä¾‹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                return false;
            }
        }

        // Modal Functions
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.add('opacity-100');
                modalElement.querySelector('.modal-content').classList.add('scale-100');
                modalElement.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function hideModal(modalElement) {
            modalElement.querySelector('.modal-content').classList.remove('scale-100');
            modalElement.querySelector('.modal-content').classList.add('scale-95');
            modalElement.classList.remove('opacity-100');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300);
        }

        function showDetailModal(caseData) {
            elements.detailModalTitle.textContent = caseData.title;
            elements.detailUseCase.textContent = caseData.useCase;
            elements.detailResult.textContent = caseData.result;
            elements.detailWelfare.textContent = caseData.welfare;

            if (caseData.videoUrl && caseData.videoUrl.trim()) {
                elements.detailVideo.innerHTML = `<a href="${caseData.videoUrl}" target="_blank" rel="noopener noreferrer" class="text-sky-600 hover:text-sky-800 hover:underline break-all">${caseData.videoUrl}</a>`;
            } else {
                elements.detailVideo.innerHTML = `<p>Coming soon</p>`;
            }

            showModal(elements.detailModal);
        }

        function showEditModal(caseData = null) {
            if (caseData) {
                elements.editModalTitle.textContent = 'äº‹ä¾‹ã‚’ç·¨é›†';
                elements.editRecordId.value = caseData.id;
                elements.editTitle.value = caseData.title;
                elements.editRole.value = caseData.role;
                elements.editServiceType.value = caseData.service_type;
                elements.editTask.value = caseData.task;
                elements.editUseCase.value = caseData.useCase;
                elements.editResult.value = caseData.result;
                elements.editWelfare.value = caseData.welfare;
                elements.editVideoUrl.value = caseData.videoUrl || '';
            } else {
                elements.editModalTitle.textContent = 'æ–°ã—ã„äº‹ä¾‹ã‚’è¿½åŠ ';
                elements.editForm.reset();
                elements.editRecordId.value = '';
            }
            showModal(elements.editModal);
        }

        function showPasswordModal() {
            elements.passwordInput.value = '';
            elements.passwordError.classList.add('hidden');
            showModal(elements.passwordModal);
        }

        // Admin Mode
        function toggleAdminMode(enable) {
            isAdminMode = enable;
            if (enable) {
                elements.adminBadge.classList.remove('hidden');
                elements.addCaseBtn.classList.remove('hidden');
                elements.adminToggle.textContent = 'ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰çµ‚äº†';
                elements.adminToggle.classList.remove('bg-sky-600', 'hover:bg-sky-700');
                elements.adminToggle.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                elements.adminBadge.classList.add('hidden');
                elements.addCaseBtn.classList.add('hidden');
                elements.adminToggle.textContent = 'ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰';
                elements.adminToggle.classList.remove('bg-red-600', 'hover:bg-red-700');
                elements.adminToggle.classList.add('bg-sky-600', 'hover:bg-sky-700');
            }
            renderCards();
        }

        // Filters
        function populateFilters() {
            const roles = ['all', ...new Set(allCases.map(c => c.role))];
            const services = ['all', ...new Set(allCases.map(c => c.service_type))];
            const tasks = ['all', ...new Set(allCases.map(c => c.task))];

            const createOptions = (selectEl, items) => {
                selectEl.innerHTML = '';
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item === 'all' ? `ã™ã¹ã¦ï¼ˆ${items.length - 1}ï¼‰` : item;
                    selectEl.appendChild(option);
                });
            };

            createOptions(elements.roleFilter, roles);
            createOptions(elements.serviceFilter, services);
            createOptions(elements.taskFilter, tasks);
        }

        // Render
        function renderCards() {
            elements.caseGallery.innerHTML = '';
            allCases.forEach(c => {
                const card = document.createElement('div');
                card.className = 'case-card bg-white p-6 rounded-lg shadow-md border border-transparent hover:border-sky-500';
                
                const fullText = `${c.title} ${c.useCase} ${c.result} ${c.welfare} ${c.role} ${c.service_type} ${c.task}`.toLowerCase();
                card.dataset.textContent = fullText;
                card.dataset.role = c.role;
                card.dataset.service = c.service_type;
                card.dataset.task = c.task;

                let adminButtons = '';
                if (isAdminMode) {
                    adminButtons = `
                        <div class="flex gap-2 mt-4">
                            <button class="edit-btn flex-1 px-3 py-1.5 bg-amber-500 text-white rounded text-sm hover:bg-amber-600" data-id="${c.id}">ç·¨é›†</button>
                            <button class="delete-btn flex-1 px-3 py-1.5 bg-red-500 text-white rounded text-sm hover:bg-red-600" data-id="${c.id}">å‰Šé™¤</button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="cursor-pointer view-detail" data-id="${c.id}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-sky-700 h-14 line-clamp-2">${c.title}</h3>
                            <span class="text-xs font-medium bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full shrink-0 ml-2">${c.service_type}</span>
                        </div>
                        <p class="text-neutral-700 mb-4 h-24 overflow-hidden text-ellipsis line-clamp-4">${c.useCase}</p>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs font-medium bg-neutral-100 text-neutral-800 px-2 py-0.5 rounded-full">${c.role}</span>
                            <span class="text-xs font-medium bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full">${c.task}</span>
                        </div>
                    </div>
                    ${adminButtons}
                `;
                elements.caseGallery.appendChild(card);
            });

            // Attach event listeners
            document.querySelectorAll('.view-detail').forEach(el => {
                el.addEventListener('click', (e) => {
                    const caseData = allCases.find(c => c.id === el.dataset.id);
                    if (caseData) showDetailModal(caseData);
                });
            });

            if (isAdminMode) {
                document.querySelectorAll('.edit-btn').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const caseData = allCases.find(c => c.id === el.dataset.id);
                        if (caseData) showEditModal(caseData);
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(el => {
                    el.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const caseData = allCases.find(c => c.id === el.dataset.id);
                        if (caseData && confirm(`ã€Œ${caseData.title}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                            const success = await deleteCase(caseData.id);
                            if (success) {
                                allCases = allCases.filter(c => c.id !== caseData.id);
                                populateFilters();
                                renderCards();
                                updateView();
                                initChart();
                            }
                        }
                    });
                });
            }

            updateView();
        }

        function updateView() {
            const searchText = elements.searchInput.value.toLowerCase();
            const selectedRole = elements.roleFilter.value;
            const selectedService = elements.serviceFilter.value;
            const selectedTask = elements.taskFilter.value;

            let count = 0;
            const cards = elements.caseGallery.querySelectorAll('.case-card');

            Array.from(cards).forEach(card => {
                const textMatch = card.dataset.textContent.includes(searchText);
                const roleMatch = selectedRole === 'all' || card.dataset.role === selectedRole;
                const serviceMatch = selectedService === 'all' || card.dataset.service === selectedService;
                const taskMatch = selectedTask === 'all' || card.dataset.task === selectedTask;

                if (textMatch && roleMatch && serviceMatch && taskMatch) {
                    card.style.display = 'block';
                    count++;
                } else {
                    card.style.display = 'none';
                }
            });

            elements.displayedCount.textContent = count;
            elements.totalCount.textContent = allCases.length;
            elements.noResults.style.display = count === 0 ? 'block' : 'none';
        }

        function formatChartLabel(label) {
            if (label.length > 10) {
                return label.match(/.{1,10}/g);
            }
            return label;
        }

        function initChart() {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            const serviceCounts = allCases.reduce((acc, c) => {
                acc[c.service_type] = (acc[c.service_type] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(serviceCounts).map(formatChartLabel);
            const data = Object.values(serviceCounts);

            if (serviceChart) {
                serviceChart.destroy();
            }

            serviceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'äº‹ä¾‹ä»¶æ•°',
                        data: data,
                        backgroundColor: [
                            'rgba(14, 165, 233, 0.6)',
                            'rgba(245, 158, 11, 0.6)',
                            'rgba(16, 185, 129, 0.6)',
                            'rgba(239, 68, 68, 0.6)',
                            'rgba(139, 92, 246, 0.6)',
                            'rgba(217, 70, 239, 0.6)'
                        ],
                        borderColor: [
                            'rgba(14, 165, 233, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(217, 70, 239, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' ä»¶';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });
        }

        // Event Listeners
        elements.closeDetailModal.addEventListener('click', () => hideModal(elements.detailModal));
        elements.detailModal.addEventListener('click', (e) => {
            if (e.target === elements.detailModal) hideModal(elements.detailModal);
        });

        elements.closeEditModal.addEventListener('click', () => hideModal(elements.editModal));
        elements.cancelEdit.addEventListener('click', () => hideModal(elements.editModal));
        elements.editModal.addEventListener('click', (e) => {
            if (e.target === elements.editModal) hideModal(elements.editModal);
        });

        elements.cancelPassword.addEventListener('click', () => hideModal(elements.passwordModal));
        elements.passwordModal.addEventListener('click', (e) => {
            if (e.target === elements.passwordModal) hideModal(elements.passwordModal);
        });

        elements.editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const caseData = {
                title: elements.editTitle.value,
                role: elements.editRole.value,
                service_type: elements.editServiceType.value,
                task: elements.editTask.value,
                useCase: elements.editUseCase.value,
                result: elements.editResult.value,
                welfare: elements.editWelfare.value,
                videoUrl: elements.editVideoUrl.value || null
            };

            const recordId = elements.editRecordId.value;
            let result;
            
            if (recordId) {
                // Update existing
                result = await updateCase(recordId, caseData);
                if (result) {
                    const index = allCases.findIndex(c => c.id === recordId);
                    if (index !== -1) {
                        allCases[index] = result;
                    }
                }
            } else {
                // Create new
                result = await createCase(caseData);
                if (result) {
                    allCases.push(result);
                }
            }

            if (result) {
                hideModal(elements.editModal);
                populateFilters();
                renderCards();
                initChart();
            }
        });

        elements.passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = elements.passwordInput.value;
            
            if (password === ADMIN_PASSWORD) {
                hideModal(elements.passwordModal);
                toggleAdminMode(true);
            } else {
                elements.passwordError.classList.remove('hidden');
            }
        });

        elements.adminToggle.addEventListener('click', () => {
            if (isAdminMode) {
                toggleAdminMode(false);
            } else {
                showPasswordModal();
            }
        });

        elements.addCaseBtn.addEventListener('click', () => {
            showEditModal();
        });

        elements.searchInput.addEventListener('keyup', updateView);
        elements.roleFilter.addEventListener('change', updateView);
        elements.serviceFilter.addEventListener('change', updateView);
        elements.taskFilter.addEventListener('change', updateView);
        elements.resetFilters.addEventListener('click', () => {
            elements.searchInput.value = '';
            elements.roleFilter.value = 'all';
            elements.serviceFilter.value = 'all';
            elements.taskFilter.value = 'all';
            updateView();
        });

        // Initialize
        async function init() {
            await loadCases();
            populateFilters();
            renderCards();
            initChart();
        }

        init();
    </script>
</body>
</html>
